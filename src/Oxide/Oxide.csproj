<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <TargetFramework>netstandard2.0</TargetFramework>
    <DebugType>portable</DebugType>
    <PackageId>Oxide</PackageId>
    <Authors>Bojan Rajkovic</Authors>
    <Title>Oxide</Title>
    <Description>A library of Rust-like types and helpers for .NET.</Description>
    <PackageRequireLicenseAcceptance>false</PackageRequireLicenseAcceptance>
    <PackageReleaseNotes>$(ReleaseNotes)</PackageReleaseNotes>
    <PackageProjectUrl>https://github.com/bojanrajkovic/Oxide</PackageProjectUrl>
    <PackageLicense>MIT</PackageLicense>
    <PackageTags>rust kotlin functional</PackageTags>
    <GenerateAssemblyCompanyAttribute>false</GenerateAssemblyCompanyAttribute>
    <GenerateAssemblyFileVersionAttribute>false</GenerateAssemblyFileVersionAttribute>
    <GenerateAssemblyInformationalVersionAttribute>false</GenerateAssemblyInformationalVersionAttribute>
    <GenerateAssemblyVersionAttribute>false</GenerateAssemblyVersionAttribute>
    <RepositoryUrl>https://github.com/bojanrajkovic/Oxide</RepositoryUrl>
    <RepositoryType>GitHub</RepositoryType>
    <GenerateDocumentationFile>true</GenerateDocumentationFile>
    <PublishRepositoryUrl>true</PublishRepositoryUrl>
    <EmbedUntrackedSources>true</EmbedUntrackedSources>
    <PackageReleaseNotes>!RELEASE_NOTES!</PackageReleaseNotes>
    <ReleaseNotesFile>$([MSBuild]::GetPathOfFileAbove(release.json))</ReleaseNotesFile>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="Microsoft.SourceLink.GitHub" Version="1.0.0" PrivateAssets="All"/>
  </ItemGroup>

  <Target Name="UpdateReleaseNotes" Condition='Exists($(ReleaseNotesFile))'>
    <Exec Command="cat $(ReleaseNotesFile) | jq -r .body" ConsoleToMSBuild="true">
      <Output TaskParameter="ConsoleOutput" PropertyName="CapturedReleaseNotes" />
    </Exec>
    <WriteLinesToFile File="ReleaseNotes.txt" Lines="$(CapturedReleaseNotes)" />
    <UpdateReleaseNotes File="$(MSBuildThisFileFullPath)" />
    <Delete Files="ReleaseNotes.txt" />
  </Target>

  <UsingTask TaskName="UpdateReleaseNotes"
             TaskFactory="RoslynCodeTaskFactory"
             AssemblyFile="$(MSBuildToolsPath)\Microsoft.Build.Tasks.Core.dll">
    <ParameterGroup>
      <File ParameterType="System.String" Required="true" />
    </ParameterGroup>
    <Task>
      <Code Type="Fragment" Language="cs"><![CDATA[
        var content = System.IO.File.ReadAllText(File);
        var replacement = System.IO.File.ReadAllText("ReleaseNotes.txt");
        content = content.Replace(string.Format("!{0}!", "RELEASE_NOTES"), string.Join(Environment.NewLine, replacement));
        System.IO.File.WriteAllText(File, content);
      ]]></Code>
    </Task>
  </UsingTask>
</Project>
